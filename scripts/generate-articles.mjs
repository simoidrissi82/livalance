import {promises as fs} from 'node:fs';
import path from 'node:path';
import {fileURLToPath} from 'node:url';
import {compileMDX} from 'next-mdx-remote/rsc';

const articleDirMap = {
  de: 'wissen',
  en: 'insights'
};

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const repoRoot = path.resolve(__dirname, '..');

async function readArticles() {
  const articles = [];

  for (const [locale, localeDir] of Object.entries(articleDirMap)) {
    const dir = path.join(repoRoot, 'content', locale, localeDir);

    let files = [];
    try {
      files = await fs.readdir(dir);
    } catch (error) {
      if ((error && error.code) === 'ENOENT') {
        continue;
      }
      throw error;
    }

    for (const file of files) {
      if (!file.endsWith('.mdx')) {
        continue;
      }

      const filePath = path.join(dir, file);
      const source = await fs.readFile(filePath, 'utf8');

      const {frontmatter} = await compileMDX({
        source,
        options: {
          parseFrontmatter: true
        }
      });

      const normalizedFrontmatter = {
        ...frontmatter,
        publishDate:
          typeof frontmatter.publishDate === 'string'
            ? frontmatter.publishDate
            : new Date(frontmatter.publishDate).toISOString()
      };

      articles.push({
        locale,
        slug: normalizedFrontmatter.slug,
        frontmatter: normalizedFrontmatter,
        source
      });
    }
  }

  articles.sort((a, b) => {
    if (a.locale === b.locale) {
      return a.slug.localeCompare(b.slug);
    }
    return a.locale.localeCompare(b.locale);
  });

  return articles;
}

async function writeOutput(articles) {
  const outputDir = path.join(repoRoot, 'src', 'lib', 'generated');
  await fs.mkdir(outputDir, {recursive: true});

  const serialized = JSON.stringify(articles, null, 2)
    .replace(/\\u2028/g, '\\u2028')
    .replace(/\\u2029/g, '\\u2029');

  const contents = `// This file is generated by scripts/generate-articles.mjs. Do not edit manually.\n\nexport const generatedArticles = ${serialized};\n`;

  const outputPath = path.join(outputDir, 'articles.ts');
  await fs.writeFile(outputPath, contents, 'utf8');
}

const articles = await readArticles();
await writeOutput(articles);
